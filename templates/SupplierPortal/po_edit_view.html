{% extends 'SupplierPortal/supplier_base.html' %}
{% block body_block %}
{% load static %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<style>
    .table-responsive {
        overflow-x: auto !important;
        white-space: nowrap;
    }
    .content-wrapper {
        background: #F5F7FF;
        padding: 2.375rem 2.375rem;
        width: 100%;
        flex-grow: 1;
    }
</style>

<div class="content-wrapper">
    <div class="container mt-5 col-md-12 mb-3">
        <form method="post">
            {% csrf_token %}
            <div class="card card-body">
                <h3>Edit Purchase Order</h3>

                {% if messages %}
                    <ul class="messages">
                        {% for message in messages %}
                            <li class="{{ message.tags }}">{{ message }}</li>
                        {% endfor %}
                    </ul>
                {% endif %}

                <div class="row">
                    <!-- Vendor Selection -->
                    <div class="col-md-3">
                        <label>Vendor <b style="color: red;">*</b></label>
                        <select name="vendor" class="form-control" required>
                            <option value="None">-------</option>
                            {% for data in vendors %}
                                <option value="{{ data.id }}" {% if data.id == order.vendor_id %} selected {% endif %}>
                                    {{ data.name }}
                                </option>
                            {% endfor %}
                        </select>
                    </div>

                    <!-- Expected Delivery Date -->
                    <div class="col-md-3">
                        <label>Expected Date <b style="color: red;">*</b></label>
                        <input type="date" name="expecteddate" value="{{ order.expected_delivery }}" class="form-control" required>
                    </div>

                    <!-- Total Amount -->
                    <div class="col-md-3">
                        <label>Total Amount <b style="color: red;">*</b></label>
                        <input type="number" name="total_amount" value="{{ order.total_amount }}" class="form-control"  required>
                    </div>

                    <div class="col-md-3">
                        <button class="btn btn-primary mt-4" type="submit">Update Order</button>
                    </div>
                </div>
            </div>
    </div>

    <!-- Order Items Table -->
    <div class="container mt-3">
        <div class="card">
            <div class="card-body">
                <h4>Edit Order Items</h4>
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Item Name</th>
                                <th>OrderType</th>
                                <th>Package</th>
                                <th>Qty</th>
                                <th id="amt">Unit Price</th>
                                <th>Discount Type</th>
                                <th>Discount Value</th>
                                <th>Total Value</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                          
                                {% for data in items %}
                                <tr>
                                    <td><input type="text" name="item_name[]" value="{{ data.item_unit.item }}" class="form-control" readonly></td>
<td>
    <select name="ordertype[]" class="form-control order-type">
        <option value="Piece" {% if data.ordertype == "Piece" %}selected{% endif %}>Piece</option>
        <option value="Package" {% if data.ordertype == "Package" %}selected{% endif %}>Package</option>
    </select>
</td>
<td>
    <select name="package[]" class="form-control item-package">
        <option value="{{ data.package_size.id }}">{{ data.package_size.package_name }} - {{ data.package_size.quantity }}</option>
    </select>
</td>
<td><input type="number" name="quantity[]" value="{{ data.quantity }}" class="form-control quantity-field"></td>
<td><input type="number" name="unit_price[]" value="{{ data.unit_price }}" class="form-control unit-price-field"></td>
<td>
    <select name="discount_type[]" class="form-control">
        <option value="None" {% if data.discount_type == "None" %}selected{% endif %}>None</option>
        <option value="Fixed" {% if data.discount_type == "Fixed" %}selected{% endif %}>Fixed</option>
        <option value="Percentage" {% if data.discount_type == "Percentage" %}selected{% endif %}>Percentage</option>
    </select>
</td>
<td><input type="number" name="discount_value[]" value="{{ data.discount }}" class="form-control discount-value-field"></td>
<td><input type="number" name="total_price[]" value="{{ data.total_price }}" class="form-control total-value-field" readonly></td>
<td>
    <a href="{% url 'delete_POtempdetails' data.id %}" class="btn btn-danger remove-btn">
        <i class="fas fa-trash"></i>
    </a>
</td>
                             
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div> 
      
        
    </div>

</div>


<!-- #=============================== getting item related packsize ============== -->

<!-- AJAX Script -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
// When OrderType changes
$(document).on("change", ".order-type", function() {
    let row = $(this).closest("tr"); // Get the current row
    let orderType = $(this).val();
    let itemUnit = row.find(".item-unit").val(); // Get selected item unit
    let packageDropdown = row.find(".item-package");

    // If "Package" is selected, fetch package sizes
    if (orderType === "Package" && itemUnit) {
        $.ajax({
            url: "{% url 'get_package_sizes' %}", // Django URL to fetch package sizes
            type: "GET",
            data: { itemunit_id: itemUnit },
            success: function(response) {
                packageDropdown.html('<option>---select---</option>'); // Reset options
                $.each(response.packages, function(index, package) {
                    packageDropdown.append(`<option value="${package.id}">${package.name} - ${package.quantity} units</option>`);
                });
            }
        });
    } else {
        packageDropdown.html('<option value="None">-------</option>'); // Reset if "Piece" is selected
    }
});
});
</script>

<!-- ====================== this function for get amount details based on order type ======= -->
<script>
$(document).ready(function() {
$(".table").on("change", ".item-unit, .order-type", function() {
    var row = $(this).closest("tr");
    var itemUnitId = row.find(".item-unit").val();
    var orderType = row.find(".order-type").val();
    var package = row.find(".item-package").val();

    if (itemUnitId) {
        $.ajax({
            url: "/get-item-price/",  // Django URL to handle the request
            type: "GET",
            data: {
                "item_unit_id": itemUnitId,
                "order_type": orderType,
                'package':package
            },
            success: function(response) {
                row.find(".unit-price-field").val(response.amount);
                row.find(".discount-value-field").val(response.discount);
                row.find(".discount_type").val(response.discounttype);
                row.find(".item_tax").val(response.tax);
            },
            error: function(xhr, status, error) {
                console.log("Error:", error);
            }
        });
    }
});
});
</script>

<!-- 
============ quantity and amount find over all cal culation =============== -->
<script>
document.addEventListener("DOMContentLoaded", function() {
    function calculateTotal() {
        let quantity = parseFloat(document.querySelector(".quantity-field").value) || 0;
        let unitPrice = parseFloat(document.querySelector(".unit-price-field").value) || 0;
        let discountType = document.querySelector("[name='discount_type']").value;
        let discountValue = parseFloat(document.querySelector(".discount-value-field").value) || 0;
        let tax = parseFloat(document.querySelector(".item_tax").value) || 0;
        let totalField = document.querySelector(".total-value-field");

        let total = quantity * unitPrice; // Base total (without discount/tax)

        // Apply Discount
        if (discountType === "Fixed") {
            total -= discountValue; // Deduct fixed amount
        } else if (discountType === "Percentage") {
            total -= (total * discountValue / 100); // Deduct percentage
        }

        // Apply Tax
        total += (total * tax / 100); // Add tax percentage

        totalField.value = total.toFixed(2); // Ensures two decimal places
    }

    // Event Listeners
    document.querySelector(".quantity-field").addEventListener("input", calculateTotal);
    document.querySelector(".unit-price-field").addEventListener("input", calculateTotal);
    document.querySelector("[name='discount_type']").addEventListener("change", calculateTotal);
    document.querySelector(".discount-value-field").addEventListener("input", calculateTotal);
    document.querySelector(".item_tax").addEventListener("input", calculateTotal);
});
</script>

{% endblock %}