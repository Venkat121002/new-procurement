{% extends 'SupplierPortal/supplier_base.html' %}
{% block body_block %}
{% load static %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<style>
.table-responsive {
    overflow-x: auto !important;
    white-space: nowrap;
}
.content-wrapper {
    background: #F5F7FF;
    padding: 2.375rem 2.375rem;
    width: 100%;
    -webkit-flex-grow: 1;
    flex-grow: 1;
    padding-top: 0px;
}
</style>
<div class="content-wrapper">
        {% csrf_token %}
        <div class="row grid-margin stretch-card">
            <div class="container mt-5 col-md-12 mb-3">
                <form method ="post" >
                    {% csrf_token %}
                <div class="card card-body">
                    <h4>Reorder Goods</h4>
                    {% if messages %}
                    <ul class="messages">
                        {% for message in messages %}
                        <li class="{% if message.tags %}{{ message.tags }}{% endif %}">
                            {{ message }}
                        </li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                    <div class="row">
                     
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="{{ form_field.id_for_label }}">
                                    Vendor/Manufacturer<b style="color: red;">*</b>
                                </label>
                                <select name="vendor" id="vendorid" class="form-control" required>
                                    <option value="None">-------</option>
                                    {% for data in vendors %}
                                    <option value="{{data.id}}">{{data.name}}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="col-md-3">
                            <div class="form-group">
                                <label>
                                    Expected Date<b style="color: red;">*</b>
                                </label>
                                <input type="date" name="expecteddate" class="form-control" required>
                            </div>
                        </div>

                        <div class="col-md-3">
                            <div class="form-group">
                                <label>
                                    Total Amount<b style="color: red;">*</b>
                                </label>
                                <input type="number" name="total_amount" value="{{total_amount}}" class="form-control" required>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label >
                                    Delivery Store<b style="color: red;">*</b>
                                </label>
                                <select name="deliverystore" id="deliverystoreid" class="form-control" required>
                                    <option value="None">-------</option>
                                    {% for data in deliverystore %}
                                    <option value="{{data.id}}">{{data.name}}({{data.storetype}})</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>


                   
                        <div class="col-md-3">
                            <div class="form-group">
                        <button class="btn btn-primary pt-10 mt-10"  type="submit">
                            Purchase
                        </button>
                    </div>
                </div>
                    </div>
      
                 
                </div>
         
            </div>
        <br>
    
            <div class="card">
                <div class="card-body">
                  
                    
                    <div class="table-responsive">
                        <table class="table" id="table_puchasegoods">
                            <thead>
                                <tr>
                                    <th>Select</th>
                                    <th>Item Name <b style="color: red;">*</b></th>
                                    <th>OrderType<b style="color: red;">*</b></th>
                                    <th>Package</th>
                                    <th>Qty<b style="color: red;">*</b></th>
                                    <th id="amt">Unit Price<b style="color: red;">*</b></th>
                                    <th>Discount Type</th>
                                    <th>Discount Value</th>
                                    <th>Tax</th>
                                    <th>Total Value<b style="color: red;">*</b></th>
                                   
                                </tr>
                            </thead>
                            <tbody>
                                    {% for data in report %}
                                    <tr>
                                        <td><input type="checkbox"  name="selected" value="{{ item.id }}" /></td>

                                        <td>
                                            <select class="form-control text-dark item-unit" style="width: 250px;" name="item_unit_{{ item.id }}">
                                                <option value="None">---select---</option>
                                                {% for item in itemunit  %}
                                                <option value="{{item.id}}" {% if item.id == data.unit_id %} selected {% endif %}>{{item.item.item_name}} ({{item.unit}}) {{item.item.brand}} </option>
                                                {% endfor %}
                                            </select>
                                        </td>
                                        <td>
                                            <select class="form-control text-dark order-type" style="width: 100px;" name="order_type_{{ item.id }}">
                                                <option value="Piece">Piece</option>
                                                <option value="Package">Package</option>  
                                            </select>
                                        </td>

                                    <td>
                                            <select class="form-control item-package" style="width: 100px;" name="item_package_{{ item.id }}">
                                                <option value="None" >-------</option>
                                        
                                            </select>
                                        </td>
                                        <td>
                                            <input type="number" class="form-control quantity-field" style="width: 100px;" value="{{data.reorder_qty}}" name="quantity_received_{{ item.id }}">
                                        </td>
                                        <td>
                                            <input type="number" class="form-control unit-price-field" value="{{data.amount}}" style="width: 100px;" name="amt_{{ item.id }}">
                                        </td>
                                        <td>
                                            <select class="form-control text-dark discount_type" name="discount_type_{{ item.id }}" style="width: 100px;">
                                                <option value="Fixed">Fixed</option>
                                                <option value="Percentage">Percentage</option>
                                            </select>
                                        </td>
                                        <td>
                                            <input type="number" class="form-control discount-value-field" style="width: 100px;" name="discount_value_{{ item.id }}" value="0">
                                        </td>
                                        <td>
                                            <input type="number" class="form-control item_tax" name = "item_tax_{{ item.id }}" style="width: 100px;" value="0">
                                        </td>
                                        <td>
                                            <input type="number" class="form-control total-value-field" name = "total_amt_{{ item.id }}" value="{{data.totalAmountss}}" style="width: 100px;" value="0" readonly>
                                        </td>
                                    
                                 
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </form> 
     
        
            
        </div>
   
    </div>
 
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function () {
    function calculateRowTotal(row) {
        let qty = parseFloat(row.find(".quantity-field").val()) || 0;
        let unitPrice = parseFloat(row.find(".unit-price-field").val()) || 0;
        let discountType = row.find(".discount_type").val();
        let discountValue = parseFloat(row.find(".discount-value-field").val()) || 0;
        let tax = parseFloat(row.find(".item_tax").val()) || 0;

        let subtotal = qty * unitPrice;

        let discountAmount = 0;
        if (discountType === "Fixed") {
            discountAmount = discountValue;
        } else if (discountType === "Percentage") {
            discountAmount = (subtotal * discountValue) / 100;
        }

        let afterDiscount = subtotal - discountAmount;
        let total = afterDiscount + tax;

        row.find(".total-value-field").val(total.toFixed(2));
    }

    // Bind events to update total
    $(document).on("input change", ".quantity-field, .unit-price-field, .discount-value-field, .item_tax, .discount_type", function () {
        let row = $(this).closest("tr");
        calculateRowTotal(row);
    });
});
</script>



{% endblock %}