{% extends 'SupplierPortal/supplier_base.html' %}
{% block body_block %}
{% load static %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<style>
.table-responsive {
    overflow-x: auto !important;
    white-space: nowrap;
}
.content-wrapper {
    background: #F5F7FF;
    padding: 2.375rem 2.375rem;
    width: 100%;
    -webkit-flex-grow: 1;
    flex-grow: 1;
    padding-top: 0px;
}
</style>
<div class="content-wrapper">
        {% csrf_token %}
        <div class="row grid-margin stretch-card mt-5">
            <form method ="post" action="">
                {% csrf_token %}
    
                <div class="card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h3 class="mb-0">Goods Receive</h3>
                            <button class="btn btn-primary" type="submit">Delivered</button>
                        </div>
                    {% if messages %}
                    <ul class="messages">
                        {% for message in messages %}
                        <li class="{% if message.tags %}{{ message.tags }}{% endif %}">
                            {{ message }}
                        </li>
                        {% endfor %}
                    </ul>
                    {% endif %}
                    <div class="row">
                     
                        <div class="col-md-2">
                            <div class="form-group">
                                <label >
                                    PO Number<b style="color: red;">*</b>
                                </label>
                                <input type="text" name="po_number" id="po_number" value="{{ordermain.po_number}}" class="form-control" readonly>
                           
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label for="{{ form_field.id_for_label }}">
                                    Vendor/manufacture<b style="color: red;">*</b>
                                </label>
                                <input type="text" name="vendor" id="vendor" value="{{ordermain.vendor}}" class="form-control" readonly>
                           
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label >
                                    Order date<b style="color: red;">*</b>
                                </label>
                                <input type="date" name="orderdate" id="orderdate" value="{{ ordermain.order_date|date:'Y-m-d' }}" class="form-control" readonly>
                           
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label >
                                    Total Amount<b style="color: red;">*</b>
                                </label>
                                <input type="number" name="total_amount" id="total_amount" value="{{ordermain.total_amount}}" class="form-control" readonly>
                           
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label >
                                    Order Status<b style="color: red;">*</b>
                                </label>
                                <input type="text" name="orderstatus" id="orderstatus" value="{{ordermain.order_status}}" class="form-control" readonly>
                           
                            </div>
                        </div>
                        <div class="col-md-2">
                            <div class="form-group">
                                <label >
                                    Received By<b style="color: red;">*</b>
                                </label>
                                <input type="text" name="Receivedby" id="Receivedby" class="form-control" required>
                           
                            </div>
                        </div>


                   
                      
                        
                   
                    </div>
      
                 
                </div>
         
            </div>
<br>
        
            <div class="card">
                <div class="card-body">
                  
                    
                    <div class="table-responsive">
                        <table class="table" id="table_puchasegoods">
                            <thead class="bg-col">
                                <tr>
                                    <th>Item Name <b style="color: red;">*</b></th>
                                    
                                    <th>Order Type</th>
                                    <th>Package<b style="color: red;">*</b></th>
                                    <th>Ordered QTY</th>
                                    <th>Unit Price<b style="color: red;">*</b></th>
                                    <th>Pending QTY</th>
                                    <th>Delivered QTY<b style="color: red;">*</b></th>
                                    <th>Batch</th>
                                    <th>Expiry Date<b style="color: red;">*</b></th>
                        
                                    <th>GRN Amount<b style="color: red;">*</b></th>
                                </tr>
                            </thead>
                            <tbody>
                                    {% for data in ordersub %}
                                    <tr>
                                        <td>{{data.item_unit.item}}-{{data.item_unit.conversion_factor_to_base}}/{{data.item_unit.unit}} <input type="hidden" name="childid" value="{{data.id}}"></td>
                                     
                                        <td>{{data.ordertype}}</td>

                                        <td>{% if data.package_size %}{{data.package_size}}{% else %}-{% endif %}</td>
                                        <td>{{data.quantity}}</td>
                                        <td>{{data.unit_price}}<input type="hidden" class="form-control unitprice" name="unitprice" id="unitprice" value="{{data.unit_price}}" style="width:150px ;"></td>
                                        <td><input type="number" class="form-control pending_qty" value="{{data.pending_received_qty}}" name="pending_qty" style="width:150px ;" readonly></td>
                                        <td><input type="number" class="form-control delivered_qty" value="{{data.pending_received_qty}}" name="delivered_qty" style="width:150px ;"></td>
                                        <td><input type="text" class="form-control" name="batchnumber" value="" style="width:150px ;"></td>
                                        <td><input type="date" class="form-control" name="expirydate" ></td>
                                    
                                        <td><input type="number" value="{{data.total_grn}}" class="form-control grnamount" name="grnamount" style="width:150px;"></td>
                                        
                                </tr>
                                {% endfor%}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </form> 
     
        </div>
   
    </div>
 

<!-- #=============================== getting item related packsize ============== -->

<!-- AJAX Script -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
$(document).ready(function() {
    // When OrderType changes
    $(document).on("change", ".order-type", function() {
        let row = $(this).closest("tr"); // Get the current row
        let orderType = $(this).val();
        let itemUnit = row.find(".item-unit").val(); // Get selected item unit
        let packageDropdown = row.find(".item-package");

        // If "Package" is selected, fetch package sizes
        if (orderType === "Package" && itemUnit) {
            $.ajax({
                url: "{% url 'get_package_sizes' %}", // Django URL to fetch package sizes
                type: "GET",
                data: { itemunit_id: itemUnit },
                success: function(response) {
                    packageDropdown.html('<option>---select---</option>'); // Reset options
                    $.each(response.packages, function(index, package) {
                        packageDropdown.append(`<option value="${package.id}">${package.name} - ${package.quantity} units</option>`);
                    });
                }
            });
        } else {
            packageDropdown.html('<option value="None">-------</option>'); // Reset if "Piece" is selected
        }
    });
});
</script>

<!-- ====================== this function for get amount details based on order type ======= -->
<script>
$(document).ready(function() {
    $(".table").on("change", ".item-unit, .order-type", function() {
        var row = $(this).closest("tr");
        var itemUnitId = row.find(".item-unit").val();
        var orderType = row.find(".order-type").val();
        var package = row.find(".item-package").val();

        if (itemUnitId) {
            $.ajax({
                url: "/get-item-price/",  // Django URL to handle the request
                type: "GET",
                data: {
                    "item_unit_id": itemUnitId,
                    "order_type": orderType,
                    'package':package
                },
                success: function(response) {
                    row.find(".unit-price-field").val(response.amount);
                    row.find(".discount-value-field").val(response.discount);
                    row.find(".discount_type").val(response.discounttype);
                    row.find(".item_tax").val(response.tax);
                },
                error: function(xhr, status, error) {
                    console.log("Error:", error);
                }
            });
        }
    });
});
</script>

<!-- 
============ quantity and amount find over all cal culation =============== -->
<script>
    document.addEventListener("DOMContentLoaded", function() {
        function calculateTotal() {
            let quantity = parseFloat(document.querySelector(".quantity-field").value) || 0;
            let unitPrice = parseFloat(document.querySelector(".unit-price-field").value) || 0;
            let discountType = document.querySelector("[name='discount_type']").value;
            let discountValue = parseFloat(document.querySelector(".discount-value-field").value) || 0;
            let tax = parseFloat(document.querySelector(".item_tax").value) || 0;
            let totalField = document.querySelector(".total-value-field");
    
            let total = quantity * unitPrice; // Base total (without discount/tax)
    
            // Apply Discount
            if (discountType === "Fixed") {
                total -= discountValue; // Deduct fixed amount
            } else if (discountType === "Percentage") {
                total -= (total * discountValue / 100); // Deduct percentage
            }
    
            // Apply Tax
            total += (total * tax / 100); // Add tax percentage
    
            totalField.value = total.toFixed(2); // Ensures two decimal places
        }
    
        // Event Listeners
        document.querySelector(".quantity-field").addEventListener("input", calculateTotal);
        document.querySelector(".unit-price-field").addEventListener("input", calculateTotal);
        document.querySelector("[name='discount_type']").addEventListener("change", calculateTotal);
        document.querySelector(".discount-value-field").addEventListener("input", calculateTotal);
        document.querySelector(".item_tax").addEventListener("input", calculateTotal);
    });
    </script>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        document.querySelectorAll(".delivered_qty").forEach(function(input) {
            input.addEventListener("input", function() {
                let row = this.closest("tr");
                let unitPrice = parseFloat(row.querySelector(".unitprice").value) || 0;
                let deliveredQty = parseFloat(this.value) || 0;
                let totalAmount = unitPrice * deliveredQty;
                
                row.querySelector(".grnamount").value = totalAmount.toFixed(2); // Display with 2 decimal places
            });
        });
    });
</script>

<!-- jQuery Script -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
  $(document).on('input', '.delivered_qty', function () {
    var $row = $(this).closest('tr');
    var pendingQty = parseFloat($row.find('.pending_qty').val()) || 0;
    var deliveredQty = parseFloat($(this).val()) || 0;

    if (deliveredQty > pendingQty) {
      alert("Delivered quantity cannot be greater than pending quantity.");
      $(this).val(pendingQty); // set it back to max allowed
    }
  });
</script>
{% endblock %}